---
import Section from '../../common/Section.astro';
import Container from '../../common/Container.astro';
import ContactForm from './ContactForm';
import Icon from '../../common/Icon.astro';
import { getPersonalData } from '../../../lib/data';

const data = getPersonalData();
const contact = data.contact;
const socials = data.socials;
const location = data.location;
const availability = data.availability;

// Helper to check if a link is a placeholder
const isPlaceholderLink = (url: string): boolean => {
  if (!url) return true;
  const placeholderPatterns = [
    /^#$/,
    /^#[^/]/,
    /example\.com/i,
    /github\.com\/example\//i,
    /placeholder/i,
    /demo\.test/i,
    /^javascript:/i,
    /linkedin\.com\/in\/example/i,
    /twitter\.com\/example/i,
  ];
  return placeholderPatterns.some((pattern) => pattern.test(url));
};

// Helper to get link type
const getLinkType = (platform: string): 'live' | 'github' | 'generic' => {
  if (platform === 'github') return 'github';
  return 'generic';
};

// Process social links
const socialLinksArray = Object.entries(socials).map(([platform, url]) => ({
  platform,
  url,
  isPlaceholder: isPlaceholderLink(url),
  linkType: getLinkType(platform),
}));
---

<Section id="contact" variant="background" class="border-t border-border">
  <Container>
    <div class="max-w-4xl mx-auto text-center mb-12 lg:mb-20 animate-item">
      <h2
        class="text-display font-bold tracking-tight mb-6 bg-gradient-to-r from-primary via-accent to-accent-alt bg-clip-text text-transparent"
        data-testid="contact-heading"
      >
        Get in Touch
      </h2>
      <p class="text-body text-secondary max-w-2xl mx-auto leading-relaxed">
        I'm currently {availability || 'open to new opportunities'}. Whether you
        have a question or just want to say hi, I'll try my best to get back to
        you!
      </p>
    </div>

    <div
      class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-24 items-start animate-item"
      data-testid="contact-grid"
    >
      {/* Left Column: Contact Info & Socials */}
      <div class="space-y-8" data-testid="contact-info">
        <div
          class="p-8 rounded-2xl border border-border bg-surface/50 backdrop-blur-sm relative overflow-hidden group"
        >
          <div
            class="absolute inset-0 bg-gradient-to-br from-accent/5 to-accent-alt/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
          >
          </div>
          <h3 class="text-h3 font-bold mb-4">Contact Information</h3>
          <p class="text-body text-secondary mb-8">
            Prefer a direct message? Feel free to reach out through any of these
            channels.
          </p>

          <div class="space-y-6">
            <div class="flex items-center gap-4 text-primary group/item">
              <span
                class="p-3 rounded-lg bg-accent/10 text-accent group-hover/item:bg-accent group-hover/item:text-white transition-all duration-300"
              >
                <Icon name="mail" class="w-6 h-6" />
              </span>
              <div class="flex flex-col">
                <span
                  class="text-xs text-secondary font-medium uppercase tracking-wider"
                  >Email</span
                >
                <a
                  href={`mailto:${contact.email}`}
                  class="text-lg font-medium hover:text-accent transition-colors"
                >
                  {contact.email}
                </a>
              </div>
            </div>

            <div class="flex items-center gap-4 text-primary group/item">
              <span
                class="p-3 rounded-lg bg-accent/10 text-accent group-hover/item:bg-accent group-hover/item:text-white transition-all duration-300"
              >
                <Icon name="map-pin" class="w-6 h-6" />
              </span>
              <div class="flex flex-col">
                <span
                  class="text-xs text-secondary font-medium uppercase tracking-wider"
                  >Location</span
                >
                <span class="text-lg font-medium">{location}</span>
              </div>
            </div>
          </div>

          <div class="mt-12 pt-12 border-t border-border/50">
            <h4
              class="text-sm font-bold text-secondary uppercase tracking-widest mb-6"
            >
              Social Profiles
            </h4>
            <div class="flex flex-wrap gap-4">
              {
                socialLinksArray.map(
                  ({ platform, url, isPlaceholder, linkType }) =>
                    isPlaceholder ? (
                      <button
                        data-placeholder-link
                        data-link-type={linkType}
                        data-link-url={url}
                        class="p-4 rounded-xl border border-border bg-surface hover:border-accent hover:text-accent hover:shadow-lg hover:shadow-accent/5 transition-all duration-300 group/social cursor-pointer"
                        aria-label={`${platform} profile (demo link)`}
                      >
                        <Icon
                          name={platform}
                          class="w-6 h-6 transition-transform group-hover/social:scale-110"
                        />
                      </button>
                    ) : (
                      <a
                        href={url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="p-4 rounded-xl border border-border bg-surface hover:border-accent hover:text-accent hover:shadow-lg hover:shadow-accent/5 transition-all duration-300 group/social"
                        aria-label={`Visit my ${platform} profile`}
                      >
                        <Icon
                          name={platform}
                          class="w-6 h-6 transition-transform group-hover/social:scale-110"
                        />
                      </a>
                    )
                )
              }
            </div>
          </div>
        </div>
      </div>

      {/* Right Column: Contact Form */}
      <div class="relative" data-testid="contact-form-container">
        <div
          class="absolute -inset-4 bg-gradient-to-r from-accent/20 to-accent-alt/20 blur-3xl opacity-20 -z-10"
        >
        </div>
        <ContactForm client:visible />
      </div>
    </div>
  </Container>
</Section>

<script>
  import { track } from '@vercel/analytics';

  // Handle placeholder link buttons in the contact section
  function setupContactPlaceholderLinks() {
    const contactSection = document.getElementById('contact');
    if (!contactSection) return;

    const placeholderButtons = contactSection.querySelectorAll(
      '[data-placeholder-link]'
    );

    placeholderButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const linkType = button.getAttribute('data-link-type') as
          | 'live'
          | 'github'
          | 'generic';
        const linkUrl = button.getAttribute('data-link-url') || '';

        track('contact_placeholder_link_click', { linkType, linkUrl });

        window.dispatchEvent(
          new CustomEvent('open-link-not-available-modal', {
            detail: { type: linkType, url: linkUrl },
          })
        );
      });
    });
  }

  // Run on initial load and after View Transitions
  setupContactPlaceholderLinks();
  document.addEventListener('astro:page-load', setupContactPlaceholderLinks);
</script>
