---
import Section from '../../common/Section.astro';
import Container from '../../common/Container.astro';
import SkillCategory from './SkillCategory.astro';
import skillsData from '../../../data/skills.json';

interface Skill {
  name: string;
  icon: string;
  level: number;
}

interface SkillCategoryData {
  category: string;
  description: string;
  skills: Skill[];
}

const typedSkillsData = skillsData as SkillCategoryData[];
---

<Section id="skills" variant="background">
  <Container>
    <div class="mb-16 max-w-2xl animate-item">
      <h2 class="font-display text-h2 mb-4 font-bold text-primary">
        Technical <span class="text-accent">Expertise</span>
      </h2>
      <p class="text-body leading-relaxed text-secondary">
        A curated selection of my technical toolbox, categorized by domain.
        Focused on building high-performance, accessible, and scalable digital
        products.
      </p>
    </div>

    <div
      class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12 animate-item"
    >
      <div class="flex flex-wrap gap-3" id="skills-filters">
        <button
          data-filter="all"
          class="px-6 py-2 rounded-full border border-border text-small font-medium transition-all hover:border-accent hover:text-accent aria-pressed:bg-accent aria-pressed:text-white aria-pressed:border-accent"
          aria-pressed="true"
        >
          All
        </button>
        {
          typedSkillsData.map((category) => (
            <button
              data-filter={category.category}
              class="px-6 py-2 rounded-full border border-border text-small font-medium transition-all hover:border-accent hover:text-accent aria-pressed:bg-accent aria-pressed:text-white aria-pressed:border-accent"
              aria-pressed="false"
            >
              {category.category}
            </button>
          ))
        }
      </div>

      <div class="relative max-w-xs w-full">
        <input
          type="text"
          id="skills-search"
          placeholder="Search skills..."
          class="w-full pl-10 pr-4 py-2 rounded-full border border-border bg-surface text-small focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all"
          aria-label="Search skills"
        />
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-secondary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-search"
            aria-hidden="true"
            ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
            ></path></svg
          >
        </div>
      </div>
    </div>

    <div
      id="skills-grid"
      class="grid grid-cols-1 gap-px bg-border lg:grid-cols-2 border border-border transition-all duration-500 animate-item"
    >
      {typedSkillsData.map((category) => <SkillCategory {...category} />)}
    </div>
  </Container>
</Section>

<script>
  const filterButtons = document.querySelectorAll('#skills-filters button');
  const skillCategories = document.querySelectorAll('[data-skill-category]');
  const searchInput = document.getElementById(
    'skills-search'
  ) as HTMLInputElement;

  function updateSkills() {
    const activeFilter = document
      .querySelector('#skills-filters button[aria-pressed="true"]')
      ?.getAttribute('data-filter');
    const searchTerm = searchInput?.value.toLowerCase() || '';

    skillCategories.forEach((cat) => {
      if (!(cat instanceof HTMLElement)) return;

      const categoryName = cat.getAttribute('data-skill-category');
      const skillCards = cat.querySelectorAll('[data-skill-name]');
      let visibleSkillsInCategory = 0;

      skillCards.forEach((card) => {
        if (!(card instanceof HTMLElement)) return;
        const skillName =
          card.getAttribute('data-skill-name')?.toLowerCase() || '';
        const matchesSearch = skillName.includes(searchTerm);

        if (matchesSearch) {
          card.style.display = 'flex';
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
          }, 10);
          visibleSkillsInCategory++;
        } else {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.95)';
          setTimeout(() => {
            card.style.display = 'none';
          }, 300);
        }
      });

      const matchesFilter =
        activeFilter === 'all' || categoryName === activeFilter;
      const shouldShowCategory = matchesFilter && visibleSkillsInCategory > 0;

      if (shouldShowCategory) {
        cat.style.display = 'block';
        setTimeout(() => {
          cat.style.opacity = '1';
          cat.style.transform = 'translateY(0)';
        }, 10);
      } else {
        cat.style.opacity = '0';
        cat.style.transform = 'translateY(10px)';
        setTimeout(() => {
          cat.style.display = 'none';
        }, 500);
      }
    });
  }

  filterButtons.forEach((button) => {
    button.addEventListener('click', () => {
      filterButtons.forEach((btn) => btn.setAttribute('aria-pressed', 'false'));
      button.setAttribute('aria-pressed', 'true');
      updateSkills();
    });
  });

  searchInput?.addEventListener('input', updateSkills);
</script>
